<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>android中so的加载(二) | x2d1</title><meta name="google-site-verification" content="u163KTfURAZuf9TQWoQRP6mIW_2y4ffpkYttxC3RYmw"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","code_fold":15,"search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"复制"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('/img/night.png');
 --light-background: url('/img/day.png');
 --theme-encrypt-confirm: '确认'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/friends/"><span class="navItemTitle">Friends</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>android中so的加载(二)</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2025-04-22T12:58:10.921Z" id="date"> 2025-04-22</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2025-04-22T13:12:47.568Z" id="updated"> 2025-04-22</time></div></span><br><span>文章总字数: <div class="control">5.7k</div></span><br><span>预计阅读时间: <div class="control">31 分钟</div></span></div></div><hr><div id="post-content"><p>上一篇文章主要分析了JAVA层的逻辑，接下来主要分析native层的逻辑，native层的入口是nativeLoad函数</p>
<h2 id="hcOFj"><a href="#hcOFj" class="headerlink" title="hcOFj"></a>nativeLoad</h2>
loadLibrary在获取到so的路径后就会调用nativeLoad，nativeLoad返回了JVM_NativeLoad函数。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// /art/openjdkjvm/OpenjdkJvm.cc</span><br><span class="hljs-built_in">Runtime_nativeLoad</span>(JNIEnv* env, jclass ignored, jstring javaFilename,<br>     jobject javaLoader, jclass caller)<br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JVM_NativeLoad</span>(env, javaFilename, javaLoader, caller);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="wVPnE"><a href="#wVPnE" class="headerlink" title="wVPnE"></a>JVM_NativeLoad</h2>
获取javaVM并调用LoadNativeLibrary

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">JNIEXPORT jstring <span class="hljs-title">JVM_NativeLoad</span><span class="hljs-params">(JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 jstring javaFilename,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 jobject javaLoader,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 jclass caller)</span> </span>&#123;<br>  <span class="hljs-function">ScopedUtfChars <span class="hljs-title">filename</span><span class="hljs-params">(env, javaFilename)</span></span>;<br>  <span class="hljs-keyword">if</span> (filename.<span class="hljs-built_in">c_str</span>() == <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  &#125;<br><br>  std::string error_msg;<br>  &#123;<br>    art::JavaVMExt* vm = art::Runtime::<span class="hljs-built_in">Current</span>()-&gt;<span class="hljs-built_in">GetJavaVM</span>();<br>    <span class="hljs-comment">//获取当前java对象</span><br>    <span class="hljs-type">bool</span> success = vm-&gt;<span class="hljs-built_in">LoadNativeLibrary</span>(env,<br>                                         filename.<span class="hljs-built_in">c_str</span>(),<br>                                         javaLoader,<br>                                         caller,<br>                                         &amp;error_msg);<br>    <span class="hljs-keyword">if</span> (success) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Don&#x27;t let a pending exception from JNI_OnLoad cause a CheckJNI issue with NewStringUTF.</span><br>  env-&gt;<span class="hljs-built_in">ExceptionClear</span>();<br>  <span class="hljs-keyword">return</span> env-&gt;<span class="hljs-built_in">NewStringUTF</span>(error_msg.<span class="hljs-built_in">c_str</span>());<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="MrOCj"><a href="#MrOCj" class="headerlink" title="MrOCj"></a>LoadNativeLibrary</h2>
1. 检查so是否已经加载，若已加载则检查alloctor避免重复加载

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//http://aospxref.com/android-10.0.0_r47/xref/art/runtime/jni/java_vm_ext.cc?fi=LoadNativeLibrary#LoadNativeLibrary</span><br> <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">JavaVMExt::LoadNativeLibrary</span><span class="hljs-params">(JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    <span class="hljs-type">const</span> std::string&amp; path,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    jobject class_loader,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    jclass caller_class,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    std::string* error_msg)</span></span><br><span class="hljs-function">    SharedLibrary* library</span>;<br>    Thread* self = Thread::<span class="hljs-built_in">Current</span>();<br>    &#123;<br>      <span class="hljs-comment">// 检查是否已经加载，若已经加载则获取ShardLibrary</span><br>      <span class="hljs-function">MutexLock <span class="hljs-title">mu</span><span class="hljs-params">(self, *Locks::jni_libraries_lock_)</span></span>;<br>      library = libraries_-&gt;<span class="hljs-built_in">Get</span>(path);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (library != <span class="hljs-literal">nullptr</span>) &#123;<br>  <span class="hljs-comment">// Use the allocator pointers for class loader equality to avoid unnecessary weak root decode.</span><br>  <span class="hljs-keyword">if</span> (library-&gt;<span class="hljs-built_in">GetClassLoaderAllocator</span>() != class_loader_allocator) &#123;<br>    <span class="hljs-comment">// The library will be associated with class_loader. The JNI</span><br>    <span class="hljs-comment">// spec says we can&#x27;t load the same library into more than one</span><br>    <span class="hljs-comment">// class loader.</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// This isn&#x27;t very common. So spend some time to get a readable message.</span><br>    ....................<br>    std::string old_class_loader = <span class="hljs-built_in">call_to_string</span>(library-&gt;<span class="hljs-built_in">GetClassLoader</span>());<br>    std::string new_class_loader = <span class="hljs-built_in">call_to_string</span>(class_loader);<br><br>    <span class="hljs-comment">// 只能被一个 ClassLoader 加载</span><br>    <span class="hljs-built_in">StringAppendF</span>(error_msg, <span class="hljs-string">&quot;Shared library \&quot;%s\&quot; already opened by &quot;</span><br>        <span class="hljs-string">&quot;ClassLoader %p(%s); can&#x27;t open in ClassLoader %p(%s)&quot;</span>,<br>        path.<span class="hljs-built_in">c_str</span>(),<br>        library-&gt;<span class="hljs-built_in">GetClassLoader</span>(),<br>        old_class_loader.<span class="hljs-built_in">c_str</span>(),<br>        class_loader,<br>        new_class_loader.<span class="hljs-built_in">c_str</span>());<br>    <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; *error_msg;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-built_in">VLOG</span>(jni) &lt;&lt; <span class="hljs-string">&quot;[Shared library \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="hljs-string">&quot;\&quot; already loaded in &quot;</span><br>            &lt;&lt; <span class="hljs-string">&quot; ClassLoader &quot;</span> &lt;&lt; class_loader &lt;&lt; <span class="hljs-string">&quot;]&quot;</span>;<br><br>  <span class="hljs-keyword">if</span> (!library-&gt;<span class="hljs-built_in">CheckOnLoadResult</span>()) &#123;<br>    <span class="hljs-built_in">StringAppendF</span>(error_msg, <span class="hljs-string">&quot;JNI_OnLoad failed on a previous attempt &quot;</span><br>        <span class="hljs-string">&quot;to load \&quot;%s\&quot;&quot;</span>, path.<span class="hljs-built_in">c_str</span>());<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>调用OpenNativeLibrary加载</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">ScopedLocalRef&lt;jstring&gt; <span class="hljs-title">library_path</span><span class="hljs-params">(env, GetLibrarySearchPath(env, class_loader))</span></span>;<br>Locks::mutator_lock_-&gt;<span class="hljs-built_in">AssertNotHeld</span>(self);<br><span class="hljs-type">const</span> <span class="hljs-type">char</span>* path_str = path.<span class="hljs-built_in">empty</span>() ? <span class="hljs-literal">nullptr</span> : path.<span class="hljs-built_in">c_str</span>();<br><span class="hljs-type">bool</span> needs_native_bridge = <span class="hljs-literal">false</span>;<br><span class="hljs-type">char</span>* nativeloader_error_msg = <span class="hljs-literal">nullptr</span>;<br><span class="hljs-type">void</span>* handle = android::<span class="hljs-built_in">OpenNativeLibrary</span>(<br>    env,<br>    runtime_-&gt;<span class="hljs-built_in">GetTargetSdkVersion</span>(),<br>    path_str,<br>    class_loader,<br>    (caller_location.<span class="hljs-built_in">empty</span>() ? <span class="hljs-literal">nullptr</span> : caller_location.<span class="hljs-built_in">c_str</span>()),<br>    library_path.<span class="hljs-built_in">get</span>(),<br>    &amp;needs_native_bridge,<br>    &amp;nativeloader_error_msg);<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>当so加载成功后立即调用JNI_OnLoad</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp">........<br><span class="hljs-type">void</span>* sym = library-&gt;<span class="hljs-built_in">FindSymbol</span>(<span class="hljs-string">&quot;JNI_OnLoad&quot;</span>, <span class="hljs-literal">nullptr</span>);<br><span class="hljs-keyword">if</span> (sym == <span class="hljs-literal">nullptr</span>) &#123;<br>  <span class="hljs-built_in">VLOG</span>(jni) &lt;&lt; <span class="hljs-string">&quot;[No JNI_OnLoad found in \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="hljs-string">&quot;\&quot;]&quot;</span>;<br>  was_successful = <span class="hljs-literal">true</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// Call JNI_OnLoad.  We have to override the current class</span><br>  <span class="hljs-comment">// loader, which will always be &quot;null&quot; since the stuff at the</span><br>  <span class="hljs-comment">// top of the stack is around Runtime.loadLibrary().  (See</span><br>  <span class="hljs-comment">// the comments in the JNI FindClass function.)</span><br>  ScopedLocalRef&lt;jobject&gt; <span class="hljs-built_in">old_class_loader</span>(env, env-&gt;<span class="hljs-built_in">NewLocalRef</span>(self-&gt;<span class="hljs-built_in">GetClassLoaderOverride</span>()));<br>  self-&gt;<span class="hljs-built_in">SetClassLoaderOverride</span>(class_loader);<br><br>  <span class="hljs-built_in">VLOG</span>(jni) &lt;&lt; <span class="hljs-string">&quot;[Calling JNI_OnLoad in \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="hljs-string">&quot;\&quot;]&quot;</span>;<br>  <span class="hljs-keyword">using</span> JNI_OnLoadFn = <span class="hljs-built_in">int</span>(*)(JavaVM*, <span class="hljs-type">void</span>*);<br>  JNI_OnLoadFn jni_on_load = <span class="hljs-built_in">reinterpret_cast</span>&lt;JNI_OnLoadFn&gt;(sym);<br>  <span class="hljs-type">int</span> version = (*jni_on_load)(<span class="hljs-keyword">this</span>, <span class="hljs-literal">nullptr</span>);<br></code></pre></td></tr></table></figure>

<h2 id="KV7lv"><a href="#KV7lv" class="headerlink" title="KV7lv"></a>OpenNativeLibrary</h2>
支持在不同的平台加载so，android平台下使用android_dlopen_ext或dlopen来加载so。

<p>如果 <code>class_loader</code> 为 <code>nullptr</code>，直接通过 <code>android_dlopen_ext</code> 或 <code>dlopen</code> 加载库。  </p>
<p>若有 <code>caller_location</code>，会根据其来查找对应的 <code>boot_namespace</code>，然后在特定命名空间内加载库。</p>
<p>如果 <code>class_loader</code> 非空，会查找并创建一个特定的 <code>NativeLoaderNamespace</code>，然后在该命名空间内加载库。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// /system/core/libnativeloader/native_loader.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">OpenNativeLibrary</span><span class="hljs-params">(JNIEnv* env, <span class="hljs-type">int32_t</span> target_sdk_version, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* path,</span></span><br><span class="hljs-params"><span class="hljs-function">jobject class_loader, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* caller_location, jstring library_path,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">bool</span>* needs_native_bridge, <span class="hljs-type">char</span>** error_msg)</span> </span>&#123;<br>    <span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__ANDROID__)</span><br>    <span class="hljs-comment">//检查宏定义是否存在</span><br>    <span class="hljs-built_in">UNUSED</span>(target_sdk_version);<br>    <span class="hljs-keyword">if</span> (class_loader == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-comment">//class_loader是否为空</span><br>        *needs_native_bridge = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (caller_location != <span class="hljs-literal">nullptr</span>) &#123;<br><br>            <span class="hljs-type">android_namespace_t</span>* boot_namespace = <span class="hljs-built_in">FindExportedNamespace</span>(caller_location);<br>            <span class="hljs-keyword">if</span> (boot_namespace != <span class="hljs-literal">nullptr</span>) &#123;<br>                <span class="hljs-comment">//初始化dlextinfo</span><br>                <span class="hljs-type">const</span> android_dlextinfo dlextinfo = &#123;<br>                .flags = ANDROID_DLEXT_USE_NAMESPACE,<br>                .library_namespace = boot_namespace,<br>            &#125;;<br>                <span class="hljs-comment">//调用了android_dlopen_ext</span><br>                <span class="hljs-type">void</span>* handle = <span class="hljs-built_in">android_dlopen_ext</span>(path, RTLD_NOW, &amp;dlextinfo);<br>                <span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">nullptr</span>) &#123;<br>                    *error_msg = <span class="hljs-built_in">strdup</span>(<span class="hljs-built_in">dlerror</span>());<br>                &#125;<br>                <span class="hljs-keyword">return</span> handle;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//调用了dlopen</span><br>        <span class="hljs-type">void</span>* handle = <span class="hljs-built_in">dlopen</span>(path, RTLD_NOW);<br>        <span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">nullptr</span>) &#123;<br>            *error_msg = <span class="hljs-built_in">strdup</span>(<span class="hljs-built_in">dlerror</span>());<br>        &#125;<br>        <span class="hljs-keyword">return</span> handle;<br>    &#125;<br><br>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(g_namespaces_mutex)</span></span>;<br>    NativeLoaderNamespace* ns;<br><br>    <span class="hljs-keyword">if</span> ((ns = g_namespaces-&gt;<span class="hljs-built_in">FindNamespaceByClassLoader</span>(env, class_loader)) == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-comment">// This is the case where the classloader was not created by ApplicationLoaders</span><br>        <span class="hljs-comment">// In this case we create an isolated not-shared namespace for it.</span><br>        std::string create_error_msg;<br>        <span class="hljs-keyword">if</span> ((ns = g_namespaces-&gt;<span class="hljs-built_in">Create</span>(env, target_sdk_version, class_loader, <span class="hljs-literal">false</span> <span class="hljs-comment">/* is_shared */</span>,<br>            <span class="hljs-literal">nullptr</span>, library_path, <span class="hljs-literal">nullptr</span>, &amp;create_error_msg)) == <span class="hljs-literal">nullptr</span>) &#123;<br>            *error_msg = <span class="hljs-built_in">strdup</span>(create_error_msg.<span class="hljs-built_in">c_str</span>());<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">OpenNativeLibraryInNamespace</span>(ns, path, needs_native_bridge, error_msg);<br>    <span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">UNUSED</span>(env, target_sdk_version, class_loader, caller_location);<br><br>    <span class="hljs-comment">// Do some best effort to emulate library-path support. It will not</span><br>    <span class="hljs-comment">// work for dependencies.</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// Note: null has a special meaning and must be preserved.</span><br>    std::string c_library_path;  <span class="hljs-comment">// Empty string by default.</span><br>    <span class="hljs-keyword">if</span> (library_path != <span class="hljs-literal">nullptr</span> &amp;&amp; path != <span class="hljs-literal">nullptr</span> &amp;&amp; path[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;/&#x27;</span>) &#123;<br>        <span class="hljs-function">ScopedUtfChars <span class="hljs-title">library_path_utf_chars</span><span class="hljs-params">(env, library_path)</span></span>;<br>        c_library_path = library_path_utf_chars.<span class="hljs-built_in">c_str</span>();<br>    &#125;<br><br>    std::vector&lt;std::string&gt; library_paths = base::<span class="hljs-built_in">Split</span>(c_library_path, <span class="hljs-string">&quot;:&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> std::string&amp; lib_path : library_paths) &#123;<br>        *needs_native_bridge = <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* path_arg;<br>        std::string complete_path;<br>        <span class="hljs-keyword">if</span> (path == <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-comment">// Preserve null.</span><br>            path_arg = <span class="hljs-literal">nullptr</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            complete_path = lib_path;<br>            <span class="hljs-keyword">if</span> (!complete_path.<span class="hljs-built_in">empty</span>()) &#123;<br>                complete_path.<span class="hljs-built_in">append</span>(<span class="hljs-string">&quot;/&quot;</span>);<br>            &#125;<br>            complete_path.<span class="hljs-built_in">append</span>(path);<br>            path_arg = complete_path.<span class="hljs-built_in">c_str</span>();<br>        &#125;<br>        <span class="hljs-type">void</span>* handle = <span class="hljs-built_in">dlopen</span>(path_arg, RTLD_NOW);<br>        <span class="hljs-keyword">if</span> (handle != <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-keyword">return</span> handle;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">NativeBridgeIsSupported</span>(path_arg)) &#123;<br>      *needs_native_bridge = <span class="hljs-literal">true</span>;<br>      handle = <span class="hljs-built_in">NativeBridgeLoadLibrary</span>(path_arg, RTLD_NOW);<br>      <span class="hljs-keyword">if</span> (handle != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">return</span> handle;<br>      &#125;<br>      *error_msg = <span class="hljs-built_in">strdup</span>(<span class="hljs-built_in">NativeBridgeGetError</span>());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      *error_msg = <span class="hljs-built_in">strdup</span>(<span class="hljs-built_in">dlerror</span>());<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="zpZTp"><a href="#zpZTp" class="headerlink" title="zpZTp"></a>android_dlopen_ext</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">///bionic/libdl/libdl.cpp</span><br>__attribute__((__weak__))<br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">android_dlopen_ext</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename, <span class="hljs-type">int</span> flag, <span class="hljs-type">const</span> android_dlextinfo* extinfo)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">void</span>* caller_addr = __builtin_return_address(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> __loader_android_dlopen_ext(filename, flag, extinfo, caller_addr);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>__builtin_return_address(0)</code> 是 GCC 的内建函数，用于获取当前函数调用栈中的返回地址。例如，当libxxx.so中使用dlopen加载某个so时，caller_addr的地址就位于libxxx.so中。当在Java中使用loadLibrary加载时，call_addr的地址就位于libart.so中。最后android_dlopen_ext调用了__loader_android_dlopen_ext 并且把caller作为参数传进去。</p>
<h2 id="wv9cI"><a href="#wv9cI" class="headerlink" title="wv9cI"></a>__loader_android_dlopen_ext</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">///bionic/libdl/libdl.cpp</span><br><span class="hljs-type">void</span>* __loader_android_dlopen_ext(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename,<br><span class="hljs-type">int</span> flags,<br><span class="hljs-type">const</span> android_dlextinfo* extinfo,<br><span class="hljs-type">const</span> <span class="hljs-type">void</span>* caller_addr) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">dlopen_ext</span>(filename, flags, extinfo, caller_addr);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="UiIKp"><a href="#UiIKp" class="headerlink" title="UiIKp"></a>dlopen_ext</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title">dlopen_ext</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">int</span> flags,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">const</span> android_dlextinfo* extinfo,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">void</span>* caller_addr)</span> </span>&#123;<br>    <span class="hljs-function">ScopedPthreadMutexLocker <span class="hljs-title">locker</span><span class="hljs-params">(&amp;g_dl_mutex)</span></span>;<br>    g_linker_logger.<span class="hljs-built_in">ResetState</span>();<br><br>    <span class="hljs-type">void</span>* result = <span class="hljs-built_in">do_dlopen</span>(filename, flags, extinfo, caller_addr);<br>    <br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">nullptr</span>) &#123;<br>        __bionic_format_dlerror(<span class="hljs-string">&quot;dlopen failed&quot;</span>, <span class="hljs-built_in">linker_get_error_buffer</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="GGHNw"><a href="#GGHNw" class="headerlink" title="GGHNw"></a>do_dlopen</h2>
在分析do_dlopen前先了解两个概念，命名空间和soinfo结构体。

<h3 id="BIqio"><a href="#BIqio" class="headerlink" title="BIqio"></a>命名空间(namespace)</h3>
 简单地说命名空间就是用来把不同模块用的动态库隔开、互不干扰，同时又能有选择地共享公共库的机制 。详细地说明可以参考[https://source.android.com/docs/core/architecture/vndk/linker-namespace?hl=zh-cn](https://source.android.com/docs/core/architecture/vndk/linker-namespace?hl=zh-cn)

<h3 id="m5Oun"><a href="#m5Oun" class="headerlink" title="m5Oun"></a>soinfo</h3>
<font style="color:rgb(0, 0, 0);">soinfo是linker加载so所涉及到的核心结构，其定义位于/</font>[<font style="color:rgb(32, 48, 162);">bionic</font>](http://aospxref.com/android-10.0.0_r47/xref/bionic/)<font style="color:rgb(0, 0, 0);">/</font>[<font style="color:rgb(32, 48, 162);">linker</font>](http://aospxref.com/android-10.0.0_r47/xref/bionic/linker/)<font style="color:rgb(0, 0, 0);">/</font>[<font style="color:rgb(32, 48, 162);">linker_soinfo.h</font>](http://aospxref.com/android-10.0.0_r47/xref/bionic/linker/linker_soinfo.h)<font style="color:rgb(32, 48, 162);">， </font>包含 so 的地址、大小、依赖、符号表、构造函数、namespace、名字等等。  



<p>find_containing_library的作用是根据caller_addr的地址遍历已加载的soinfo，获取caller所在的so的soinfo。随后使用get_caller_namespace获取caller的命名空间。这段代码的核心是调用了find_library来实现查找加载，链接so。如果加载成功，使用call_constructors调用init函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">do_dlopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> flags,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">const</span> android_dlextinfo* extinfo,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">void</span>* caller_addr)</span> </span>&#123;<br>    std::string trace_prefix = std::<span class="hljs-built_in">string</span>(<span class="hljs-string">&quot;dlopen: &quot;</span>) + (name == <span class="hljs-literal">nullptr</span> ? <span class="hljs-string">&quot;(nullptr)&quot;</span> : name);<br>    <span class="hljs-function">ScopedTrace <span class="hljs-title">trace</span><span class="hljs-params">(trace_prefix.c_str())</span></span>;<br>    <span class="hljs-function">ScopedTrace <span class="hljs-title">loading_trace</span><span class="hljs-params">((trace_prefix + <span class="hljs-string">&quot; - loading and linking&quot;</span>).c_str())</span></span>;<br>    <br>    soinfo* <span class="hljs-type">const</span> caller = <span class="hljs-built_in">find_containing_library</span>(caller_addr);<br>    <br>    <span class="hljs-type">android_namespace_t</span>* ns = <span class="hljs-built_in">get_caller_namespace</span>(caller);<br><br>    <span class="hljs-built_in">LD_LOG</span>(kLogDlopen,<br>        <span class="hljs-string">&quot;dlopen(name=\&quot;%s\&quot;, flags=0x%x, extinfo=%s, caller=\&quot;%s\&quot;, caller_ns=%s@%p, targetSdkVersion=%i) ...&quot;</span>,<br>        name,<br>        flags,<br>        <span class="hljs-built_in">android_dlextinfo_to_string</span>(extinfo).<span class="hljs-built_in">c_str</span>(),<br>        caller == <span class="hljs-literal">nullptr</span> ? <span class="hljs-string">&quot;(null)&quot;</span> : caller-&gt;<span class="hljs-built_in">get_realpath</span>(),<br>        ns == <span class="hljs-literal">nullptr</span> ? <span class="hljs-string">&quot;(null)&quot;</span> : ns-&gt;<span class="hljs-built_in">get_name</span>(),<br>        ns,<br>        <span class="hljs-built_in">get_application_target_sdk_version</span>());<br><br>    <span class="hljs-keyword">auto</span> purge_guard = android::base::<span class="hljs-built_in">make_scope_guard</span>([&amp;]() &#123; <span class="hljs-built_in">purge_unused_memory</span>(); &#125;);<br><br>    <span class="hljs-keyword">auto</span> failure_guard = android::base::<span class="hljs-built_in">make_scope_guard</span>(<br>    [&amp;]() &#123; <span class="hljs-built_in">LD_LOG</span>(kLogDlopen, <span class="hljs-string">&quot;... dlopen failed: %s&quot;</span>, <span class="hljs-built_in">linker_get_error_buffer</span>()); &#125;);<br><br>    <span class="hljs-keyword">if</span> ((flags &amp; ~(RTLD_NOW|RTLD_LAZY|RTLD_LOCAL|RTLD_GLOBAL|RTLD_NODELETE|RTLD_NOLOAD)) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;invalid flags to dlopen: %x&quot;</span>, flags);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (extinfo != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-comment">//检查动态库加载的信息</span><br>        <span class="hljs-keyword">if</span> ((extinfo-&gt;flags &amp; ~(ANDROID_DLEXT_VALID_FLAG_BITS)) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;invalid extended flags to android_dlopen_ext: 0x%&quot;</span> PRIx64, extinfo-&gt;flags);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD) == <span class="hljs-number">0</span> &amp;&amp;<br>            (extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;invalid extended flag combination (ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET without &quot;</span><br>                <span class="hljs-string">&quot;ANDROID_DLEXT_USE_LIBRARY_FD): 0x%&quot;</span> PRIx64, extinfo-&gt;flags);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_NAMESPACE) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (extinfo-&gt;library_namespace == <span class="hljs-literal">nullptr</span>) &#123;<br>                <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;ANDROID_DLEXT_USE_NAMESPACE is set but extinfo-&gt;library_namespace is null&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>            &#125;<br>            ns = extinfo-&gt;library_namespace;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Workaround for dlopen(/system/lib/&lt;soname&gt;) when .so is in /apex. http://b/121248172</span><br>    <span class="hljs-comment">// The workaround works only when targetSdkVersion &lt; Q.</span><br>    std::string name_to_apex;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">translateSystemPathToApexPath</span>(name, &amp;name_to_apex)) &#123;<br>        <span class="hljs-comment">// APEX 路径处理</span><br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* new_name = name_to_apex.<span class="hljs-built_in">c_str</span>();<br>        <span class="hljs-built_in">LD_LOG</span>(kLogDlopen, <span class="hljs-string">&quot;dlopen considering translation from %s to APEX path %s&quot;</span>,<br>            name,<br>            new_name);<br>        <span class="hljs-comment">// Some APEXs could be optionally disabled. Only translate the path</span><br>        <span class="hljs-comment">// when the old file is absent and the new file exists.</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">file_exists</span>(new_name)) &#123;<br>            <span class="hljs-built_in">LD_LOG</span>(kLogDlopen, <span class="hljs-string">&quot;dlopen %s does not exist, not translating&quot;</span>,<br>                   new_name);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">LD_LOG</span>(kLogDlopen, <span class="hljs-string">&quot;dlopen translation accepted: using %s&quot;</span>, new_name);<br>            name = new_name;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// End Workaround for dlopen(/system/lib/&lt;soname&gt;) when .so is in /apex.</span><br><br>    std::string asan_name_holder;<br>    <span class="hljs-comment">//ASAN路径处理</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* translated_name = name;<br>    <span class="hljs-keyword">if</span> (g_is_asan &amp;&amp; translated_name != <span class="hljs-literal">nullptr</span> &amp;&amp; translated_name[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;/&#x27;</span>) &#123;<br>        <span class="hljs-type">char</span> original_path[PATH_MAX];<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">realpath</span>(name, original_path) != <span class="hljs-literal">nullptr</span>) &#123;<br>            asan_name_holder = std::<span class="hljs-built_in">string</span>(kAsanLibDirPrefix) + original_path;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exists</span>(asan_name_holder.<span class="hljs-built_in">c_str</span>())) &#123;<br>                soinfo* si = <span class="hljs-literal">nullptr</span>;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">find_loaded_library_by_realpath</span>(ns, original_path, <span class="hljs-literal">true</span>, &amp;si)) &#123;<br>                    <span class="hljs-built_in">PRINT</span>(<span class="hljs-string">&quot;linker_asan dlopen NOT translating \&quot;%s\&quot; -&gt; \&quot;%s\&quot;: library already loaded&quot;</span>, name,<br>                          asan_name_holder.<span class="hljs-built_in">c_str</span>());<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-built_in">PRINT</span>(<span class="hljs-string">&quot;linker_asan dlopen translating \&quot;%s\&quot; -&gt; \&quot;%s\&quot;&quot;</span>, name, translated_name);<br>                    translated_name = asan_name_holder.<span class="hljs-built_in">c_str</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    ProtectedDataGuard guard;<br>    <span class="hljs-comment">//通过find_library加载so，返回目标so的soinfo</span><br>    soinfo* si = <span class="hljs-built_in">find_library</span>(ns, translated_name, flags, extinfo, caller);<br>    loading_trace.<span class="hljs-built_in">End</span>();<br><br>    <span class="hljs-keyword">if</span> (si != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-type">void</span>* handle = si-&gt;<span class="hljs-built_in">to_handle</span>();<br>        <span class="hljs-built_in">LD_LOG</span>(kLogDlopen,<br>               <span class="hljs-string">&quot;... dlopen calling constructors: realpath=\&quot;%s\&quot;, soname=\&quot;%s\&quot;, handle=%p&quot;</span>,<br>               si-&gt;<span class="hljs-built_in">get_realpath</span>(), si-&gt;<span class="hljs-built_in">get_soname</span>(), handle);<br>        <span class="hljs-comment">//调用call_constructores - init函数</span><br>        si-&gt;<span class="hljs-built_in">call_constructors</span>();<br>        failure_guard.<span class="hljs-built_in">Disable</span>();<br>        <span class="hljs-built_in">LD_LOG</span>(kLogDlopen,<br>               <span class="hljs-string">&quot;... dlopen successful: realpath=\&quot;%s\&quot;, soname=\&quot;%s\&quot;, handle=%p&quot;</span>,<br>               si-&gt;<span class="hljs-built_in">get_realpath</span>(), si-&gt;<span class="hljs-built_in">get_soname</span>(), handle);<br>        <span class="hljs-keyword">return</span> handle;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">soinfo::call_constructors</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (constructors_called) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    constructors_called = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">is_main_executable</span>() &amp;&amp; preinit_array_ != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-comment">// The GNU dynamic linker silently ignores these, but we warn the developer.</span><br>        <span class="hljs-built_in">PRINT</span>(<span class="hljs-string">&quot;\&quot;%s\&quot;: ignoring DT_PREINIT_ARRAY in shared library!&quot;</span>, <span class="hljs-built_in">get_realpath</span>());<br>    &#125;<br>    <span class="hljs-comment">//递归调用子库的构造函数</span><br>    <span class="hljs-built_in">get_children</span>().for_each([] (soinfo* si) &#123;<br>        si-&gt;<span class="hljs-built_in">call_constructors</span>();<br>    &#125;);<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">is_linker</span>()) &#123;<br>        <span class="hljs-built_in">bionic_trace_begin</span>((std::<span class="hljs-built_in">string</span>(<span class="hljs-string">&quot;calling constructors: &quot;</span>) + <span class="hljs-built_in">get_realpath</span>()).<span class="hljs-built_in">c_str</span>());<br>    &#125;<br><br>    <span class="hljs-comment">// DT_INIT should be called before DT_INIT_ARRAY if both are present.</span><br>    <span class="hljs-comment">//调用init</span><br>    <span class="hljs-built_in">call_function</span>(<span class="hljs-string">&quot;DT_INIT&quot;</span>, init_func_, <span class="hljs-built_in">get_realpath</span>());<br>    <span class="hljs-comment">//调用.init_array</span><br>    <span class="hljs-built_in">call_array</span>(<span class="hljs-string">&quot;DT_INIT_ARRAY&quot;</span>, init_array_, init_array_count_, <span class="hljs-literal">false</span>, <span class="hljs-built_in">get_realpath</span>());<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">is_linker</span>()) &#123;<br>        <span class="hljs-built_in">bionic_trace_end</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="UImFU"><a href="#UImFU" class="headerlink" title="UImFU"></a>find_library</h2>
find_library会调用find_libraries查找并返回指定库的soinfo，若加载成功则增加引用计数并返回。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> soinfo* <span class="hljs-title">find_library</span><span class="hljs-params">(<span class="hljs-type">android_namespace_t</span>* ns,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> rtld_flags,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">const</span> android_dlextinfo* extinfo,</span></span><br><span class="hljs-params"><span class="hljs-function">soinfo* needed_by)</span> </span>&#123;<br>    soinfo* si = <span class="hljs-literal">nullptr</span>;<br><br>    <span class="hljs-keyword">if</span> (name == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-comment">//获取so本身的soinfo</span><br>        si = <span class="hljs-built_in">solist_get_somain</span>();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">find_libraries</span>(ns,<br>        needed_by,<br>        &amp;name,<br>        <span class="hljs-number">1</span>,<br>        &amp;si,<br>        <span class="hljs-literal">nullptr</span>,<br>        <span class="hljs-number">0</span>,<br>        rtld_flags,<br>        extinfo,<br>        <span class="hljs-literal">false</span> <span class="hljs-comment">/* add_as_children */</span>,<br>        <span class="hljs-literal">true</span> <span class="hljs-comment">/* search_linked_namespaces */</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (si != <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-built_in">soinfo_unload</span>(si);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    si-&gt;<span class="hljs-built_in">increment_ref_count</span>();<br><br>    <span class="hljs-keyword">return</span> si;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="i4J4H"><a href="#i4J4H" class="headerlink" title="i4J4H"></a>find_libraries</h2>
参数解释

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">find_libraries</span><span class="hljs-params">(<span class="hljs-type">android_namespace_t</span>* ns,     <span class="hljs-comment">//caller的命名空间</span></span></span><br><span class="hljs-params"><span class="hljs-function">                    soinfo* start_with,          <span class="hljs-comment">//caller</span></span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-type">const</span> library_names[],  <span class="hljs-comment">//SoName</span></span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">size_t</span> library_names_count,      <span class="hljs-comment">// 要加载的库的数量 == 1</span></span></span><br><span class="hljs-params"><span class="hljs-function">                    soinfo* soinfos[],           <span class="hljs-comment">// 存放已加载的soinfo</span></span></span><br><span class="hljs-params"><span class="hljs-function">                    std::vector&lt;soinfo*&gt;* ld_preloads,  <span class="hljs-comment">//预加载的soinfo指针</span></span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">size_t</span> ld_preloads_count,    <span class="hljs-comment">//预加载so数量</span></span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">int</span> rtld_flags,              <span class="hljs-comment">//链接标记</span></span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">const</span> android_dlextinfo* extinfo,     </span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">bool</span> add_as_children,       <span class="hljs-comment">//是否添加为子库</span></span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">bool</span> search_linked_namespaces,      <span class="hljs-comment">//是否在链接的命名空间搜索</span></span></span><br><span class="hljs-params"><span class="hljs-function">                    std::vector&lt;<span class="hljs-type">android_namespace_t</span>*&gt;* namespaces)</span></span><br></code></pre></td></tr></table></figure>

<h5 id="xs0Q3"><a href="#xs0Q3" class="headerlink" title="xs0Q3"></a>准备工作</h5>
这部分主要是将要加载的so加入到待加载队列load_taskds中。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp">list of libraries to link - see step <span class="hljs-number">2.</span>  std::unordered_map&lt;<span class="hljs-type">const</span> soinfo*, ElfReader&gt; readers_map;<br>  LoadTaskList load_tasks;<br><br>  <span class="hljs-comment">// 将要加载的库加入队列</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; library_names_count; ++i) &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name = library_names[i];<br>    load_tasks.<span class="hljs-built_in">push_back</span>(LoadTask::<span class="hljs-built_in">create</span>(name, start_with, ns, &amp;readers_map));<br>  &#125;<br><br>  <span class="hljs-comment">// If soinfos array is null allocate one on stack.</span><br>  <span class="hljs-comment">// The array is needed in case of failure; for example</span><br>  <span class="hljs-comment">// when library_names[] = &#123;libone.so, libtwo.so&#125; and libone.so</span><br>  <span class="hljs-comment">// is loaded correctly but libtwo.so failed for some reason.</span><br>  <span class="hljs-comment">// In this case libone.so should be unloaded on return.</span><br>  <span class="hljs-comment">// See also implementation of failure_guard below.</span><br>  <span class="hljs-keyword">if</span> (soinfos == <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-type">size_t</span> soinfos_size = <span class="hljs-built_in">sizeof</span>(soinfo*) * library_names_count;<br>    soinfos = <span class="hljs-built_in">reinterpret_cast</span>&lt;soinfo**&gt;(<span class="hljs-built_in">alloca</span>(soinfos_size));<br>    <span class="hljs-built_in">memset</span>(soinfos, <span class="hljs-number">0</span>, soinfos_size);<br>  &#125;<br><br>  <span class="hljs-comment">// list of libraries to link - see step 2.</span><br>  <span class="hljs-type">size_t</span> soinfos_count = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">auto</span> scope_guard = android::base::<span class="hljs-built_in">make_scope_guard</span>([&amp;]() &#123;<br>    <span class="hljs-keyword">for</span> (LoadTask* t : load_tasks) &#123;<br>      LoadTask::<span class="hljs-built_in">deleter</span>(t);<br>    &#125;<br>  &#125;);<br><br>  ZipArchiveCache zip_archive_cache;<br></code></pre></td></tr></table></figure>

<h5 id="a0opI"><a href="#a0opI" class="headerlink" title="a0opI"></a>将依赖库添加到load_tasks</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Step 1: expand the list of load_tasks to include</span><br><span class="hljs-comment">// all DT_NEEDED libraries (do not load them just yet)</span><br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; load_tasks.<span class="hljs-built_in">size</span>(); ++i) &#123;<br>  LoadTask* task = load_tasks[i];<br>    <span class="hljs-comment">//遍历每个任务</span><br>  soinfo* needed_by = task-&gt;<span class="hljs-built_in">get_needed_by</span>();<br>  <span class="hljs-comment">// 获取被依赖的库，也就是caller</span><br>  <span class="hljs-type">bool</span> is_dt_needed = needed_by != <span class="hljs-literal">nullptr</span> &amp;&amp; (needed_by != start_with || add_as_children);<br>  <br>  task-&gt;<span class="hljs-built_in">set_extinfo</span>(is_dt_needed ? <span class="hljs-literal">nullptr</span> : extinfo);<br>  task-&gt;<span class="hljs-built_in">set_dt_needed</span>(is_dt_needed);<br>  <br>  <span class="hljs-built_in">LD_LOG</span>(kLogDlopen, <span class="hljs-string">&quot;find_libraries(ns=%s): task=%s, is_dt_needed=%d&quot;</span>, ns-&gt;<span class="hljs-built_in">get_name</span>(),<br>         task-&gt;<span class="hljs-built_in">get_name</span>(), is_dt_needed);<br><br>  <span class="hljs-comment">// Note: start from the namespace that is stored in the LoadTask. This namespace</span><br>  <span class="hljs-comment">// is different from the current namespace when the LoadTask is for a transitive</span><br>  <span class="hljs-comment">// dependency and the lib that created the LoadTask is not found in the</span><br>  <span class="hljs-comment">// current namespace but in one of the linked namespace.</span><br>    <br>  <span class="hljs-comment">// 调用find_library_internal</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">find_library_internal</span>(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">android_namespace_t</span>*&gt;(task-&gt;<span class="hljs-built_in">get_start_from</span>()),<br>                             task,<br>                             &amp;zip_archive_cache,<br>                             &amp;load_tasks,<br>                             rtld_flags,<br>                             search_linked_namespaces || is_dt_needed)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>    <br>  <span class="hljs-comment">//获取加载后so的soinfo</span><br>  soinfo* si = task-&gt;<span class="hljs-built_in">get_soinfo</span>();<br>  <span class="hljs-comment">//添加依赖</span><br>  <span class="hljs-keyword">if</span> (is_dt_needed) &#123;<br>    needed_by-&gt;<span class="hljs-built_in">add_child</span>(si);<br>  &#125;<br><br>  <span class="hljs-comment">// When ld_preloads is not null, the first</span><br>  <span class="hljs-comment">// ld_preloads_count libs are in fact ld_preloads.</span><br>  <span class="hljs-keyword">if</span> (ld_preloads != <span class="hljs-literal">nullptr</span> &amp;&amp; soinfos_count &lt; ld_preloads_count) &#123;<br>    ld_preloads-&gt;<span class="hljs-built_in">push_back</span>(si);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (soinfos_count &lt; library_names_count) &#123;<br>    soinfos[soinfos_count++] = si;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="PR3fY"><a href="#PR3fY" class="headerlink" title="PR3fY"></a>find_library_internal</h6>
1. 通过find_loaded_library_by_soname查看so是否已经被加载过
2. 若没有加载就调用load_library来查找依赖库
3. 灰名单处理(某种兼容性的机制)，若is_greylist_enabled启用则会在全局命名空间中查找
4. 在链接的其他命名空间查找

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">find_library_internal</span><span class="hljs-params">(<span class="hljs-type">android_namespace_t</span>* ns,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   LoadTask* task,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   ZipArchiveCache* zip_archive_cache,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   LoadTaskList* load_tasks,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   <span class="hljs-type">int</span> rtld_flags,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   <span class="hljs-type">bool</span> search_linked_namespaces)</span> </span>&#123;<br>    soinfo* candidate;<br>    <span class="hljs-comment">//若已加载，直接返回</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">find_loaded_library_by_soname</span>(ns, task-&gt;<span class="hljs-built_in">get_name</span>(), search_linked_namespaces, &amp;candidate)) &#123;<br>        <span class="hljs-built_in">LD_LOG</span>(kLogDlopen,<br>               <span class="hljs-string">&quot;find_library_internal(ns=%s, task=%s): Already loaded (by soname): %s&quot;</span>,<br>               ns-&gt;<span class="hljs-built_in">get_name</span>(), task-&gt;<span class="hljs-built_in">get_name</span>(), candidate-&gt;<span class="hljs-built_in">get_realpath</span>());<br>        task-&gt;<span class="hljs-built_in">set_soinfo</span>(candidate);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// Library might still be loaded, the accurate detection</span><br>    <span class="hljs-comment">// of this fact is done by load_library.</span><br>    <span class="hljs-built_in">TRACE</span>(<span class="hljs-string">&quot;[ \&quot;%s\&quot; find_loaded_library_by_soname failed (*candidate=%s@%p). Trying harder... ]&quot;</span>,<br>          task-&gt;<span class="hljs-built_in">get_name</span>(), candidate == <span class="hljs-literal">nullptr</span> ? <span class="hljs-string">&quot;n/a&quot;</span> : candidate-&gt;<span class="hljs-built_in">get_realpath</span>(), candidate);<br>    <span class="hljs-comment">//加载so</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">load_library</span>(ns, task, zip_archive_cache, load_tasks, rtld_flags, search_linked_namespaces)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// TODO(dimitry): workaround for http://b/26394120 (the grey-list)</span><br>    <span class="hljs-keyword">if</span> (ns-&gt;<span class="hljs-built_in">is_greylist_enabled</span>() &amp;&amp; <span class="hljs-built_in">is_greylisted</span>(ns, task-&gt;<span class="hljs-built_in">get_name</span>(), task-&gt;<span class="hljs-built_in">get_needed_by</span>())) &#123;<br>        <span class="hljs-comment">// For the libs in the greylist, switch to the default namespace and then</span><br>        <span class="hljs-comment">// try the load again from there. The library could be loaded from the</span><br>        <span class="hljs-comment">// default namespace or from another namespace (e.g. runtime) that is linked</span><br>        <span class="hljs-comment">// from the default namespace.</span><br>        <span class="hljs-built_in">LD_LOG</span>(kLogDlopen,<br>               <span class="hljs-string">&quot;find_library_internal(ns=%s, task=%s): Greylisted library - trying namespace %s&quot;</span>,<br>               ns-&gt;<span class="hljs-built_in">get_name</span>(), task-&gt;<span class="hljs-built_in">get_name</span>(), g_default_namespace.<span class="hljs-built_in">get_name</span>());<br>        ns = &amp;g_default_namespace;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">load_library</span>(ns, task, zip_archive_cache, load_tasks, rtld_flags,<br>                         search_linked_namespaces)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// END OF WORKAROUND</span><br><br>    <span class="hljs-keyword">if</span> (search_linked_namespaces) &#123;<br>        <span class="hljs-comment">// if a library was not found - look into linked namespaces</span><br>        <span class="hljs-comment">// preserve current dlerror in the case it fails.</span><br>        DlErrorRestorer dlerror_restorer;<br>        <span class="hljs-built_in">LD_LOG</span>(kLogDlopen, <span class="hljs-string">&quot;find_library_internal(ns=%s, task=%s): Trying %zu linked namespaces&quot;</span>,<br>               ns-&gt;<span class="hljs-built_in">get_name</span>(), task-&gt;<span class="hljs-built_in">get_name</span>(), ns-&gt;<span class="hljs-built_in">linked_namespaces</span>().<span class="hljs-built_in">size</span>());<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; linked_namespace : ns-&gt;<span class="hljs-built_in">linked_namespaces</span>()) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">find_library_in_linked_namespace</span>(linked_namespace, task)) &#123;<br>                <span class="hljs-keyword">if</span> (task-&gt;<span class="hljs-built_in">get_soinfo</span>() == <span class="hljs-literal">nullptr</span>) &#123;<br>                    <span class="hljs-comment">// try to load the library - once namespace boundary is crossed</span><br>                    <span class="hljs-comment">// we need to load a library within separate load_group</span><br>                    <span class="hljs-comment">// to avoid using symbols from foreign namespace while.</span><br>                    <span class="hljs-comment">//</span><br>                    <span class="hljs-comment">// However, actual linking is deferred until when the global group</span><br>                    <span class="hljs-comment">// is fully identified and is applied to all namespaces.</span><br>                    <span class="hljs-comment">// Otherwise, the libs in the linked namespace won&#x27;t get symbols from</span><br>                    <span class="hljs-comment">// the global group.</span><br>                    <span class="hljs-comment">//</span><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">load_library</span>(linked_namespace.<span class="hljs-built_in">linked_namespace</span>(), task, zip_archive_cache, load_tasks, rtld_flags, <span class="hljs-literal">false</span>)) &#123;<br>                        <span class="hljs-built_in">LD_LOG</span>(<br>                            kLogDlopen, <span class="hljs-string">&quot;find_library_internal(ns=%s, task=%s): Found in linked namespace %s&quot;</span>,<br>                            ns-&gt;<span class="hljs-built_in">get_name</span>(), task-&gt;<span class="hljs-built_in">get_name</span>(), linked_namespace.<span class="hljs-built_in">linked_namespace</span>()-&gt;<span class="hljs-built_in">get_name</span>());<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// lib is already loaded</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="cmxEk"><a href="#cmxEk" class="headerlink" title="cmxEk"></a>load_library</h6>
通过extinfo中的标志来判断是否需要fd来加载该库，这个标志在OpenNativeLibrary中被定义为了ANDROID_DLEXT_USE_NAMESPACE。那么这里就不会进入这条分支，而是直接通过open_library打开文件获取文件描述符。最后调用重载的load_library方法。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">load_library</span><span class="hljs-params">(<span class="hljs-type">android_namespace_t</span>* ns,</span></span><br><span class="hljs-params"><span class="hljs-function">                         LoadTask* task,</span></span><br><span class="hljs-params"><span class="hljs-function">                         ZipArchiveCache* zip_archive_cache,</span></span><br><span class="hljs-params"><span class="hljs-function">                         LoadTaskList* load_tasks,</span></span><br><span class="hljs-params"><span class="hljs-function">                         <span class="hljs-type">int</span> rtld_flags,</span></span><br><span class="hljs-params"><span class="hljs-function">                         <span class="hljs-type">bool</span> search_linked_namespaces)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name = task-&gt;<span class="hljs-built_in">get_name</span>();<br>    soinfo* needed_by = task-&gt;<span class="hljs-built_in">get_needed_by</span>();<br>    <span class="hljs-type">const</span> android_dlextinfo* extinfo = task-&gt;<span class="hljs-built_in">get_extinfo</span>();<br><br>    <span class="hljs-type">off64_t</span> file_offset;<br>    std::string realpath;<br>    <br>    <span class="hljs-keyword">if</span> (extinfo != <span class="hljs-literal">nullptr</span> &amp;&amp; (extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD) != <span class="hljs-number">0</span>) &#123;<br>        file_offset = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> ((extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET) != <span class="hljs-number">0</span>) &#123;<br>            file_offset = extinfo-&gt;library_fd_offset;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">realpath_fd</span>(extinfo-&gt;library_fd, &amp;realpath)) &#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">is_first_stage_init</span>()) &#123;<br>                <span class="hljs-built_in">PRINT</span>(<br>                    <span class="hljs-string">&quot;warning: unable to get realpath for the library \&quot;%s\&quot; by extinfo-&gt;library_fd. &quot;</span><br>                    <span class="hljs-string">&quot;Will use given name.&quot;</span>,<br>                    name);<br>            &#125;<br>            realpath = name;<br>        &#125;<br><br>        task-&gt;<span class="hljs-built_in">set_fd</span>(extinfo-&gt;library_fd, <span class="hljs-literal">false</span>);<br>        task-&gt;<span class="hljs-built_in">set_file_offset</span>(file_offset);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">load_library</span>(ns, task, load_tasks, rtld_flags, realpath, search_linked_namespaces);<br>    &#125;<br><br>    <span class="hljs-comment">// Open the file.</span><br>    <span class="hljs-comment">//打开文件并且获取文件描述符</span><br>    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">open_library</span>(ns, zip_archive_cache, name, needed_by, &amp;file_offset, &amp;realpath);<br>    <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;library \&quot;%s\&quot; not found&quot;</span>, name);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">//设置fd</span><br>    task-&gt;<span class="hljs-built_in">set_fd</span>(fd, <span class="hljs-literal">true</span>);<br>    task-&gt;<span class="hljs-built_in">set_file_offset</span>(file_offset);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">load_library</span>(ns, task, load_tasks, rtld_flags, realpath, search_linked_namespaces);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="g1uDW"><a href="#g1uDW" class="headerlink" title="g1uDW"></a>load_library(重载)</h6>
前半部分主要是合法性检测，调用了task->read(realpath.c_str(), file_stat.st_size)来解析ELF文件，之后遍历dynamic解析符号，最后解析依赖库并且将他们也添加到LoadTasks中。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">load_library</span><span class="hljs-params">(<span class="hljs-type">android_namespace_t</span>* ns,</span></span><br><span class="hljs-params"><span class="hljs-function">                         LoadTask* task,</span></span><br><span class="hljs-params"><span class="hljs-function">                         LoadTaskList* load_tasks,</span></span><br><span class="hljs-params"><span class="hljs-function">                         <span class="hljs-type">int</span> rtld_flags,</span></span><br><span class="hljs-params"><span class="hljs-function">                         <span class="hljs-type">const</span> std::string&amp; realpath,</span></span><br><span class="hljs-params"><span class="hljs-function">                         <span class="hljs-type">bool</span> search_linked_namespaces)</span> </span>&#123;<br>    <span class="hljs-type">off64_t</span> file_offset = task-&gt;<span class="hljs-built_in">get_file_offset</span>();<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name = task-&gt;<span class="hljs-built_in">get_name</span>();<br>    <span class="hljs-type">const</span> android_dlextinfo* extinfo = task-&gt;<span class="hljs-built_in">get_extinfo</span>();<br><br>    <span class="hljs-built_in">LD_LOG</span>(kLogDlopen, <span class="hljs-string">&quot;load_library(ns=%s, task=%s, flags=0x%x, realpath=%s)&quot;</span>,<br>           ns-&gt;<span class="hljs-built_in">get_name</span>(), name, rtld_flags, realpath.<span class="hljs-built_in">c_str</span>());<br>     <span class="hljs-comment">//检查file_offset是否对齐</span><br>    <span class="hljs-keyword">if</span> ((file_offset % PAGE_SIZE) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;file offset for the library \&quot;%s\&quot; is not page-aligned: %&quot;</span> PRId64, name, file_offset);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (file_offset &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;file offset for the library \&quot;%s\&quot; is negative: %&quot;</span> PRId64, name, file_offset);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> file_stat;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">fstat</span>(task-&gt;<span class="hljs-built_in">get_fd</span>(), &amp;file_stat)) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;unable to stat file for the library \&quot;%s\&quot;: %s&quot;</span>, name, <span class="hljs-built_in">strerror</span>(errno));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (file_offset &gt;= file_stat.st_size) &#123;<br>        <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;file offset for the library \&quot;%s\&quot; &gt;= file size: %&quot;</span> PRId64 <span class="hljs-string">&quot; &gt;= %&quot;</span> PRId64,<br>               name, file_offset, file_stat.st_size);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (extinfo == <span class="hljs-literal">nullptr</span> || (extinfo-&gt;flags &amp; ANDROID_DLEXT_FORCE_LOAD) == <span class="hljs-number">0</span>) &#123;<br>        soinfo* si = <span class="hljs-literal">nullptr</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">find_loaded_library_by_inode</span>(ns, file_stat, file_offset, search_linked_namespaces, &amp;si)) &#123;<br>            <span class="hljs-built_in">LD_LOG</span>(kLogDlopen,<br>                   <span class="hljs-string">&quot;load_library(ns=%s, task=%s): Already loaded under different name/path \&quot;%s\&quot; - &quot;</span><br>                   <span class="hljs-string">&quot;will return existing soinfo&quot;</span>,<br>                   ns-&gt;<span class="hljs-built_in">get_name</span>(), name, si-&gt;<span class="hljs-built_in">get_realpath</span>());<br>            task-&gt;<span class="hljs-built_in">set_soinfo</span>(si);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((rtld_flags &amp; RTLD_NOLOAD) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;library \&quot;%s\&quot; wasn&#x27;t loaded and RTLD_NOLOAD prevented it&quot;</span>, name);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">statfs</span> fs_stat;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">fstatfs</span>(task-&gt;<span class="hljs-built_in">get_fd</span>(), &amp;fs_stat)) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;unable to fstatfs file for the library \&quot;%s\&quot;: %s&quot;</span>, name, <span class="hljs-built_in">strerror</span>(errno));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((fs_stat.f_type != TMPFS_MAGIC) &amp;&amp; (!ns-&gt;<span class="hljs-built_in">is_accessible</span>(realpath))) &#123;<br>        <span class="hljs-type">const</span> soinfo* needed_by = task-&gt;<span class="hljs-built_in">is_dt_needed</span>() ? task-&gt;<span class="hljs-built_in">get_needed_by</span>() : <span class="hljs-literal">nullptr</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_greylisted</span>(ns, name, needed_by)) &#123;<br>            <span class="hljs-keyword">if</span> (needed_by == <span class="hljs-literal">nullptr</span> || !<span class="hljs-built_in">is_system_library</span>(needed_by-&gt;<span class="hljs-built_in">get_realpath</span>())) &#123;<br>                <span class="hljs-type">const</span> soinfo* needed_or_dlopened_by = task-&gt;<span class="hljs-built_in">get_needed_by</span>();<br>                <span class="hljs-type">const</span> <span class="hljs-type">char</span>* sopath = needed_or_dlopened_by == <span class="hljs-literal">nullptr</span> ? <span class="hljs-string">&quot;(unknown)&quot;</span> :<br>                                                               needed_or_dlopened_by-&gt;<span class="hljs-built_in">get_realpath</span>();<br>                <span class="hljs-built_in">DL_WARN_documented_change</span>(__ANDROID_API_N__,<br>                                          <span class="hljs-string">&quot;private-api-enforced-for-api-level-24&quot;</span>,<br>                                          <span class="hljs-string">&quot;library \&quot;%s\&quot; (\&quot;%s\&quot;) needed or dlopened by \&quot;%s\&quot; &quot;</span><br>                                          <span class="hljs-string">&quot;is not accessible by namespace \&quot;%s\&quot;&quot;</span>,<br>                                          name, realpath.<span class="hljs-built_in">c_str</span>(), sopath, ns-&gt;<span class="hljs-built_in">get_name</span>());<br>                <span class="hljs-built_in">add_dlwarning</span>(sopath, <span class="hljs-string">&quot;unauthorized access to&quot;</span>,  name);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">const</span> <span class="hljs-type">char</span>* needed_or_dlopened_by = task-&gt;<span class="hljs-built_in">get_needed_by</span>() == <span class="hljs-literal">nullptr</span> ?<br>                                                <span class="hljs-string">&quot;(unknown)&quot;</span> :<br>                                                task-&gt;<span class="hljs-built_in">get_needed_by</span>()-&gt;<span class="hljs-built_in">get_realpath</span>();<br>            <span class="hljs-built_in">DL_ERR</span>(<span class="hljs-string">&quot;library \&quot;%s\&quot; needed or dlopened by \&quot;%s\&quot; is not accessible for the namespace \&quot;%s\&quot;&quot;</span>,<br>                   name, needed_or_dlopened_by, ns-&gt;<span class="hljs-built_in">get_name</span>());<br><br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">maybe_accessible_via_namespace_links</span>(ns, name)) &#123;<br>                <span class="hljs-built_in">PRINT</span>(<span class="hljs-string">&quot;library \&quot;%s\&quot; (\&quot;%s\&quot;) needed or dlopened by \&quot;%s\&quot; is not accessible for the&quot;</span><br>                      <span class="hljs-string">&quot; namespace: [name=\&quot;%s\&quot;, ld_library_paths=\&quot;%s\&quot;, default_library_paths=\&quot;%s\&quot;,&quot;</span><br>                      <span class="hljs-string">&quot; permitted_paths=\&quot;%s\&quot;]&quot;</span>,<br>                      name, realpath.<span class="hljs-built_in">c_str</span>(),<br>                      needed_or_dlopened_by,<br>                      ns-&gt;<span class="hljs-built_in">get_name</span>(),<br>                      android::base::<span class="hljs-built_in">Join</span>(ns-&gt;<span class="hljs-built_in">get_ld_library_paths</span>(), <span class="hljs-string">&#x27;:&#x27;</span>).<span class="hljs-built_in">c_str</span>(),<br>                      android::base::<span class="hljs-built_in">Join</span>(ns-&gt;<span class="hljs-built_in">get_default_library_paths</span>(), <span class="hljs-string">&#x27;:&#x27;</span>).<span class="hljs-built_in">c_str</span>(),<br>                      android::base::<span class="hljs-built_in">Join</span>(ns-&gt;<span class="hljs-built_in">get_permitted_paths</span>(), <span class="hljs-string">&#x27;:&#x27;</span>).<span class="hljs-built_in">c_str</span>());<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//初始化了一个soinfo</span><br>    soinfo* si = <span class="hljs-built_in">soinfo_alloc</span>(ns, realpath.<span class="hljs-built_in">c_str</span>(), &amp;file_stat, file_offset, rtld_flags);<br>    <span class="hljs-keyword">if</span> (si == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">//将soinfo添加到task</span><br>    task-&gt;<span class="hljs-built_in">set_soinfo</span>(si);<br>    <span class="hljs-comment">//</span><br>    <span class="hljs-keyword">if</span> (!task-&gt;<span class="hljs-built_in">read</span>(realpath.<span class="hljs-built_in">c_str</span>(), file_stat.st_size)) &#123;<br>        <span class="hljs-built_in">soinfo_free</span>(si);<br>        task-&gt;<span class="hljs-built_in">set_soinfo</span>(<span class="hljs-literal">nullptr</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">//解析dynamic</span><br>    <span class="hljs-type">const</span> ElfReader&amp; elf_reader = task-&gt;<span class="hljs-built_in">get_elf_reader</span>();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-built_in">ElfW</span>(Dyn)* d = elf_reader.<span class="hljs-built_in">dynamic</span>(); d-&gt;d_tag != DT_NULL; ++d) &#123;<br>        <span class="hljs-keyword">if</span> (d-&gt;d_tag == DT_RUNPATH) &#123;<br>            <span class="hljs-comment">//DT_RUNPATH</span><br>            si-&gt;<span class="hljs-built_in">set_dt_runpath</span>(elf_reader.<span class="hljs-built_in">get_string</span>(d-&gt;d_un.d_val));<br>        &#125;<br>        <span class="hljs-keyword">if</span> (d-&gt;d_tag == DT_SONAME) &#123;<br>            <span class="hljs-comment">//DT_SONAME</span><br>            si-&gt;<span class="hljs-built_in">set_soname</span>(elf_reader.<span class="hljs-built_in">get_string</span>(d-&gt;d_un.d_val));<br>        &#125;<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !defined(__ANDROID__)</span><br>    <span class="hljs-keyword">if</span> (si-&gt;<span class="hljs-built_in">get_dt_runpath</span>().<span class="hljs-built_in">empty</span>()) &#123;<br>        si-&gt;<span class="hljs-built_in">set_dt_runpath</span>(<span class="hljs-string">&quot;$ORIGIN/../lib64:$ORIGIN/lib64&quot;</span>);<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-comment">//解析依赖库</span><br>    for_each_dt_needed(task-&gt;<span class="hljs-built_in">get_elf_reader</span>(), [&amp;](<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name) &#123;<br>        <span class="hljs-built_in">LD_LOG</span>(kLogDlopen, <span class="hljs-string">&quot;load_library(ns=%s, task=%s): Adding DT_NEEDED task: %s&quot;</span>,<br>               ns-&gt;<span class="hljs-built_in">get_name</span>(), task-&gt;<span class="hljs-built_in">get_name</span>(), name);<br>        <span class="hljs-comment">//将依赖库添加到load_tasks</span><br>        load_tasks-&gt;<span class="hljs-built_in">push_back</span>(LoadTask::<span class="hljs-built_in">create</span>(name, si, ns, task-&gt;<span class="hljs-built_in">get_readers_map</span>()));<br>    &#125;);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h6 id="hkDFN"><a href="#hkDFN" class="headerlink" title="hkDFN"></a>Task::read</h6>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* realpath, <span class="hljs-type">off64_t</span> file_size)</span> </span>&#123;<br>      ElfReader&amp; elf_reader = <span class="hljs-built_in">get_elf_reader</span>();<br>      <span class="hljs-keyword">return</span> elf_reader.<span class="hljs-built_in">Read</span>(realpath, fd_, file_offset_, file_size);<br>    &#125;<br></code></pre></td></tr></table></figure>

<h6 id="qQ94a"><a href="#qQ94a" class="headerlink" title="qQ94a"></a>ElfReader::Read</h6>
函数的功能主要是读取ElF头，验证ELF头，读取程序头，读取节区头，读取DynamicSection

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ElfReader::Read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> fd, <span class="hljs-type">off64_t</span> file_offset, <span class="hljs-type">off64_t</span> file_size)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (did_read_) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>  name_ = name;<br>  fd_ = fd;<br>  file_offset_ = file_offset;<br>  file_size_ = file_size;<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ReadElfHeader</span>() &amp;&amp;<br>      <span class="hljs-built_in">VerifyElfHeader</span>() &amp;&amp;<br>      <span class="hljs-built_in">ReadProgramHeaders</span>() &amp;&amp;<br>      <span class="hljs-built_in">ReadSectionHeaders</span>() &amp;&amp;<br>      <span class="hljs-built_in">ReadDynamicSection</span>()) &#123;<br>    did_read_ = <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> did_read_;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="zPg7t"><a href="#zPg7t" class="headerlink" title="zPg7t"></a>随机顺序加载库</h5>
使用shuffle将load_list中的tasks打乱，之后设置加载时内存空间中的一些参数，最后调用Task.load将所有的segment映射到内存中。

<p class='item-img' data-src='/2025/04/22/android_load_so2/1.png'><img src="/2025/04/22/android_load_so2/1.png"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs cpp">    <span class="hljs-comment">// Step 2: Load libraries in random order (see b/24047022)</span><br>    LoadTaskList load_list;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; task : load_tasks) &#123;<br>        soinfo* si = task-&gt;<span class="hljs-built_in">get_soinfo</span>();<br>        <span class="hljs-keyword">auto</span> pred = [&amp;](<span class="hljs-type">const</span> LoadTask* t) &#123;<br>            <span class="hljs-keyword">return</span> t-&gt;<span class="hljs-built_in">get_soinfo</span>() == si;<br>        &#125;;<br>        <br>        <span class="hljs-comment">//将load_tasks中的未链接的so加入load_list中</span><br>        <span class="hljs-keyword">if</span> (!si-&gt;<span class="hljs-built_in">is_linked</span>() &amp;&amp;<br>            std::<span class="hljs-built_in">find_if</span>(load_list.<span class="hljs-built_in">begin</span>(), load_list.<span class="hljs-built_in">end</span>(), pred) == load_list.<span class="hljs-built_in">end</span>()) &#123;<br>            load_list.<span class="hljs-built_in">push_back</span>(task);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-type">bool</span> reserved_address_recursive = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (extinfo) &#123;<br>        reserved_address_recursive = extinfo-&gt;flags &amp; ANDROID_DLEXT_RESERVED_ADDRESS_RECURSIVE;<br>    &#125;<br><span class="hljs-comment">//获取extinfo中的reserved_address_recursive标志，决定了是否乱序加载</span><br>    <span class="hljs-keyword">if</span> (!reserved_address_recursive) &#123;<br>        <span class="hljs-comment">// Shuffle the load order in the normal case, but not if we are loading all</span><br>        <span class="hljs-comment">// the libraries to a reserved address range.</span><br>        <span class="hljs-built_in">shuffle</span>(&amp;load_list);<br>        <span class="hljs-comment">//shuffle将load_Tasks打乱</span><br>    &#125;<br><br>    <span class="hljs-comment">// 设置地址空间中各项参数</span><br>    address_space_params extinfo_params, default_params;<br>    <span class="hljs-type">size_t</span> relro_fd_offset = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (extinfo) &#123;<br>        <span class="hljs-keyword">if</span> (extinfo-&gt;flags &amp; ANDROID_DLEXT_RESERVED_ADDRESS) &#123;<br>            extinfo_params.start_addr = extinfo-&gt;reserved_addr;<br>            extinfo_params.reserved_size = extinfo-&gt;reserved_size;<br>            extinfo_params.must_use_address = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (extinfo-&gt;flags &amp; ANDROID_DLEXT_RESERVED_ADDRESS_HINT) &#123;<br>            extinfo_params.start_addr = extinfo-&gt;reserved_addr;<br>            extinfo_params.reserved_size = extinfo-&gt;reserved_size;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; task : load_list) &#123;<br>        address_space_params* address_space =<br>            (reserved_address_recursive || !task-&gt;<span class="hljs-built_in">is_dt_needed</span>()) ? &amp;extinfo_params : &amp;default_params;<br>        <br>        <span class="hljs-comment">//执行加载操作</span><br>        <span class="hljs-keyword">if</span> (!task-&gt;<span class="hljs-built_in">load</span>(address_space)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h5 id="yVv5e"><a href="#yVv5e" class="headerlink" title="yVv5e"></a>预链接依赖库</h5>
按广度优先预链接所有依赖库并注册TLS

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Step 3: pre-link all DT_NEEDED libraries in breadth first order.</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; task : load_tasks) &#123;<br>    soinfo* si = task-&gt;<span class="hljs-built_in">get_soinfo</span>();<br>    <span class="hljs-comment">//prelink_image完成预链接的功能</span><br>    <span class="hljs-keyword">if</span> (!si-&gt;<span class="hljs-built_in">is_linked</span>() &amp;&amp; !si-&gt;<span class="hljs-built_in">prelink_image</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-built_in">register_soinfo_tls</span>(si);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="qlCDr"><a href="#qlCDr" class="headerlink" title="qlCDr"></a>构建全局库组</h5>
在android平台下每个so被加载都对应了一个命名空间，不同的命名空间是隔离的，而全局组里的库则是全局可见。 

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp">    <span class="hljs-comment">// Step 4: Construct the global group. Note: DF_1_GLOBAL bit of a library is</span><br>    <span class="hljs-comment">// determined at step 3.</span><br><br>    <span class="hljs-comment">// Step 4-1: DF_1_GLOBAL bit is force set for LD_PRELOADed libs because they</span><br>    <span class="hljs-comment">// must be added to the global group</span><br><span class="hljs-comment">//把LD_PRELOAD加入global group</span><br>    <span class="hljs-keyword">if</span> (ld_preloads != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; si : *ld_preloads) &#123;<br>            si-&gt;<span class="hljs-built_in">set_dt_flags_1</span>(si-&gt;<span class="hljs-built_in">get_dt_flags_1</span>() | DF_1_GLOBAL);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Step 4-2: Gather all DF_1_GLOBAL libs which were newly loaded during this</span><br>    <span class="hljs-comment">// run. These will be the new member of the global group</span><br><span class="hljs-comment">//把DF_1_GLOBAL以设置或未完成链接的添加到新全局组</span><br>    <span class="hljs-type">soinfo_list_t</span> new_global_group_members;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; task : load_tasks) &#123;<br>        soinfo* si = task-&gt;<span class="hljs-built_in">get_soinfo</span>();<br>        <span class="hljs-keyword">if</span> (!si-&gt;<span class="hljs-built_in">is_linked</span>() &amp;&amp; (si-&gt;<span class="hljs-built_in">get_dt_flags_1</span>() &amp; DF_1_GLOBAL) != <span class="hljs-number">0</span>) &#123;<br>            new_global_group_members.<span class="hljs-built_in">push_back</span>(si);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Step 4-3: Add the new global group members to all the linked namespaces</span><br><span class="hljs-comment">//将新全局组添加到所有链接的命名空间</span><br>    <span class="hljs-keyword">if</span> (namespaces != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> linked_ns : *namespaces) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> si : new_global_group_members) &#123;<br>                <span class="hljs-keyword">if</span> (si-&gt;<span class="hljs-built_in">get_primary_namespace</span>() != linked_ns) &#123;<br>                    linked_ns-&gt;<span class="hljs-built_in">add_soinfo</span>(si);<br>                    si-&gt;<span class="hljs-built_in">add_secondary_namespace</span>(linked_ns);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h5 id="H01L9"><a href="#H01L9" class="headerlink" title="H01L9"></a>收集本地组的根节点</h5>
loacal_groups是指一组相互依赖，在同一个命名空间中的so。如果依赖关系跨越了命名空间就得新建一个group单独链接。这段代码作用就是把所有跨命名空间依赖的库收集起来单独链接。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Step 5: Collect roots of local_groups.</span><br><span class="hljs-comment">// Whenever needed_by-&gt;si link crosses a namespace boundary it forms its own local_group.</span><br><span class="hljs-comment">// Here we collect new roots to link them separately later on. Note that we need to avoid</span><br><span class="hljs-comment">// collecting duplicates. Also the order is important. They need to be linked in the same</span><br><span class="hljs-comment">// BFS order we link individual libraries.</span><br>std::vector&lt;soinfo*&gt; local_group_roots;<br><span class="hljs-keyword">if</span> (start_with != <span class="hljs-literal">nullptr</span> &amp;&amp; add_as_children) &#123;<br>    local_group_roots.<span class="hljs-built_in">push_back</span>(start_with);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">CHECK</span>(soinfos_count == <span class="hljs-number">1</span>);<br>    local_group_roots.<span class="hljs-built_in">push_back</span>(soinfos[<span class="hljs-number">0</span>]);<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; task : load_tasks) &#123;<br>    soinfo* si = task-&gt;<span class="hljs-built_in">get_soinfo</span>();<br>    soinfo* needed_by = task-&gt;<span class="hljs-built_in">get_needed_by</span>();<br>    <span class="hljs-type">bool</span> is_dt_needed = needed_by != <span class="hljs-literal">nullptr</span> &amp;&amp; (needed_by != start_with || add_as_children);<br>    <span class="hljs-type">android_namespace_t</span>* needed_by_ns =<br>        is_dt_needed ? needed_by-&gt;<span class="hljs-built_in">get_primary_namespace</span>() : ns;<br><br>    <span class="hljs-keyword">if</span> (!si-&gt;<span class="hljs-built_in">is_linked</span>() &amp;&amp; si-&gt;<span class="hljs-built_in">get_primary_namespace</span>() != needed_by_ns) &#123;<br>        <span class="hljs-keyword">auto</span> it = std::<span class="hljs-built_in">find</span>(local_group_roots.<span class="hljs-built_in">begin</span>(), local_group_roots.<span class="hljs-built_in">end</span>(), si);<br>        <span class="hljs-built_in">LD_LOG</span>(kLogDlopen,<br>               <span class="hljs-string">&quot;Crossing namespace boundary (si=%s@%p, si_ns=%s@%p, needed_by=%s@%p, ns=%s@%p, needed_by_ns=%s@%p) adding to local_group_roots: %s&quot;</span>,<br>               si-&gt;<span class="hljs-built_in">get_realpath</span>(),<br>               si,<br>               si-&gt;<span class="hljs-built_in">get_primary_namespace</span>()-&gt;<span class="hljs-built_in">get_name</span>(),<br>               si-&gt;<span class="hljs-built_in">get_primary_namespace</span>(),<br>               needed_by == <span class="hljs-literal">nullptr</span> ? <span class="hljs-string">&quot;(nullptr)&quot;</span> : needed_by-&gt;<span class="hljs-built_in">get_realpath</span>(),<br>               needed_by,<br>               ns-&gt;<span class="hljs-built_in">get_name</span>(),<br>               ns,<br>               needed_by_ns-&gt;<span class="hljs-built_in">get_name</span>(),<br>               needed_by_ns,<br>               it == local_group_roots.<span class="hljs-built_in">end</span>() ? <span class="hljs-string">&quot;yes&quot;</span> : <span class="hljs-string">&quot;no&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (it == local_group_roots.<span class="hljs-built_in">end</span>()) &#123;<br>            local_group_roots.<span class="hljs-built_in">push_back</span>(si);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="SHSab"><a href="#SHSab" class="headerlink" title="SHSab"></a>在local_group中链接各个引用组</h5>
遍历local_group中的每个soinfo,若没有链接过且属于当前namespace就调用si->image进行重定位。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Step 6: Link all local groups</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> root : local_group_roots) &#123;<br>    <span class="hljs-type">soinfo_list_t</span> local_group;<br>    <span class="hljs-type">android_namespace_t</span>* local_group_ns = root-&gt;<span class="hljs-built_in">get_primary_namespace</span>();<br>    <span class="hljs-comment">//收集local_space</span><br>    <span class="hljs-built_in">walk_dependencies_tree</span>(root,<br>                           [&amp;] (soinfo* si) &#123;<br>                               <span class="hljs-keyword">if</span> (local_group_ns-&gt;<span class="hljs-built_in">is_accessible</span>(si)) &#123;<br>                                   local_group.<span class="hljs-built_in">push_back</span>(si);<br>                                   <span class="hljs-keyword">return</span> kWalkContinue;<br>                               &#125; <span class="hljs-keyword">else</span> &#123;<br>                                   <span class="hljs-keyword">return</span> kWalkSkip;<br>                               &#125;<br>                           &#125;);<br><br>    <span class="hljs-type">soinfo_list_t</span> global_group = local_group_ns-&gt;<span class="hljs-built_in">get_global_group</span>();<br>    <span class="hljs-type">bool</span> linked = local_group.<span class="hljs-built_in">visit</span>([&amp;](soinfo* si) &#123;<br>        <span class="hljs-comment">// Even though local group may contain accessible soinfos from other namespaces</span><br>        <span class="hljs-comment">// we should avoid linking them (because if they are not linked -&gt; they</span><br>        <span class="hljs-comment">// are in the local_group_roots and will be linked later).</span><br>        <span class="hljs-comment">//检查条件</span><br>        <span class="hljs-keyword">if</span> (!si-&gt;<span class="hljs-built_in">is_linked</span>() &amp;&amp; si-&gt;<span class="hljs-built_in">get_primary_namespace</span>() == local_group_ns) &#123;<br>            <span class="hljs-type">const</span> android_dlextinfo* link_extinfo = <span class="hljs-literal">nullptr</span>;<br>            <span class="hljs-keyword">if</span> (si == soinfos[<span class="hljs-number">0</span>] || reserved_address_recursive) &#123;<br>                <span class="hljs-comment">// Only forward extinfo for the first library unless the recursive</span><br>                <span class="hljs-comment">// flag is set.</span><br>                link_extinfo = extinfo;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!si-&gt;<span class="hljs-built_in">link_image</span>(global_group, local_group, link_extinfo, &amp;relro_fd_offset) ||<br>                !<span class="hljs-built_in">get_cfi_shadow</span>()-&gt;<span class="hljs-built_in">AfterLoad</span>(si, <span class="hljs-built_in">solist_get_head</span>())) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;);<br><br>    <span class="hljs-keyword">if</span> (!linked) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="i9eoD"><a href="#i9eoD" class="headerlink" title="i9eoD"></a>标记所有已链接的依赖库并增加引用计数</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Step 7: Mark all load_tasks as linked and increment refcounts</span><br><span class="hljs-comment">// for references between load_groups (at this point it does not matter if</span><br><span class="hljs-comment">// referenced load_groups were loaded by previous dlopen or as part of this</span><br><span class="hljs-comment">// one on step 6)</span><br><span class="hljs-keyword">if</span> (start_with != <span class="hljs-literal">nullptr</span> &amp;&amp; add_as_children) &#123;<br>    start_with-&gt;<span class="hljs-built_in">set_linked</span>();<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; task : load_tasks) &#123;<br>    soinfo* si = task-&gt;<span class="hljs-built_in">get_soinfo</span>();<br>    si-&gt;<span class="hljs-built_in">set_linked</span>();<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; task : load_tasks) &#123;<br>    soinfo* si = task-&gt;<span class="hljs-built_in">get_soinfo</span>();<br>    soinfo* needed_by = task-&gt;<span class="hljs-built_in">get_needed_by</span>();<br>    <span class="hljs-keyword">if</span> (needed_by != <span class="hljs-literal">nullptr</span> &amp;&amp;<br>        needed_by != start_with &amp;&amp;<br>        needed_by-&gt;<span class="hljs-built_in">get_local_group_root</span>() != si-&gt;<span class="hljs-built_in">get_local_group_root</span>()) &#123;<br>        si-&gt;<span class="hljs-built_in">increment_ref_count</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure>



<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dasusu/p/9810673.html">https://www.cnblogs.com/dasusu/p/9810673.html</a> </p>
<p><a target="_blank" rel="noopener" href="https://oacia.dev/android-load-so/">https://oacia.dev/android-load-so/</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903993668272141">https://juejin.cn/post/6844903993668272141</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2025/04/15/android_load_so1/">android中so的加载(一) 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a><a onclick="BgmControl()"><svg id="bgm-control" viewBox="0 0 30 34" fill="#18d1ff" style="width: 24px; transition: transform .3s;margin-top: 4px"><path d="M25.998 23.422V11.29h3.999v12.132h-3.999zM19.497 6.234h4.001v22.243h-4.001V6.234zM12.998.867h4v32.978h-4V.867zm-6.5 5.367h4.001v22.243H6.498V6.234zm-6.5 5.056h4v12.132h-4V11.29z"></path></svg><audio id="bgm" src="/audio/bgm.mp3" autoplay loop crossorigin="anonymous"> </audio></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/x2d1.jpg" alt="Logo" style="margin:0;border-radius:0;"></a><h1 id="Dr"><a href="/">x2d1</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/x2d1"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" href="mailto:la0da.hy@gmail.com"><i class="fa fa-envelope" alt="E-Mail"></i></a><a class="social" target="_blank" rel="noopener" href="https://t.me/x2d1_0d00"><i class="fa-brands fa-telegram" alt="Telegram"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#hcOFj"><span class="toc-number">1.</span> <span class="toc-text">nativeLoad</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wVPnE"><span class="toc-number">2.</span> <span class="toc-text">JVM_NativeLoad</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MrOCj"><span class="toc-number">3.</span> <span class="toc-text">LoadNativeLibrary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KV7lv"><span class="toc-number">4.</span> <span class="toc-text">OpenNativeLibrary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zpZTp"><span class="toc-number">5.</span> <span class="toc-text">android_dlopen_ext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wv9cI"><span class="toc-number">6.</span> <span class="toc-text">__loader_android_dlopen_ext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UiIKp"><span class="toc-number">7.</span> <span class="toc-text">dlopen_ext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GGHNw"><span class="toc-number">8.</span> <span class="toc-text">do_dlopen</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BIqio"><span class="toc-number">8.1.</span> <span class="toc-text">命名空间(namespace)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#m5Oun"><span class="toc-number">8.2.</span> <span class="toc-text">soinfo</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UImFU"><span class="toc-number">9.</span> <span class="toc-text">find_library</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#i4J4H"><span class="toc-number">10.</span> <span class="toc-text">find_libraries</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#xs0Q3"><span class="toc-number">10.0.0.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#a0opI"><span class="toc-number">10.0.0.2.</span> <span class="toc-text">将依赖库添加到load_tasks</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#PR3fY"><span class="toc-number">10.0.0.2.1.</span> <span class="toc-text">find_library_internal</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#cmxEk"><span class="toc-number">10.0.0.2.2.</span> <span class="toc-text">load_library</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#g1uDW"><span class="toc-number">10.0.0.2.3.</span> <span class="toc-text">load_library(重载)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#hkDFN"><span class="toc-number">10.0.0.2.4.</span> <span class="toc-text">Task::read</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#qQ94a"><span class="toc-number">10.0.0.2.5.</span> <span class="toc-text">ElfReader::Read</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#zPg7t"><span class="toc-number">10.0.0.3.</span> <span class="toc-text">随机顺序加载库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#yVv5e"><span class="toc-number">10.0.0.4.</span> <span class="toc-text">预链接依赖库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#qlCDr"><span class="toc-number">10.0.0.5.</span> <span class="toc-text">构建全局库组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#H01L9"><span class="toc-number">10.0.0.6.</span> <span class="toc-text">收集本地组的根节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SHSab"><span class="toc-number">10.0.0.7.</span> <span class="toc-text">在local_group中链接各个引用组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#i9eoD"><span class="toc-number">10.0.0.8.</span> <span class="toc-text">标记所有已链接的依赖库并增加引用计数</span></a></li></ol></li></ol></li></ol></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> 主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>